<html>
  <head>
    <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
  </head>
  <body onload="init();">
     <canvas id="mycanvas" width="500" height="300"></canvas>
     <script type="text/javascript">

      var g = new createjs.Graphics();
      var stage = new createjs.Stage("mycanvas");
      var STAGE_WIDTH = 500;
      var STAGE_HEIGHT = 300;
      var branchLength = 100;
      var SCALE_FACTOR = 3/5; // length each branch should be of previous branch
      var SCALE_FACTOR_OFFSET = 1/4; // percentage a branch length can be randomly scaled by
      var MAX_ITERS = 8;
      var ANG_L = Math.PI/6;
      var ANG_R = -Math.PI/6;
      var ANG_OFFSET = Math.PI/10;

      var branches = [];  // holds all branches

      // f, t = from and to position
      // iter: iter number this branch was created on
      function branch(f, t, iter) {
        this.from = f;
        this.to = t;
        if(iter === undefined) {
          this.iter = 1;
        } else {
          this.iter = iter;
        }
        this.drawn = false;
        this.branched = false;

        this.info = function() {
          console.log(this.from, this.to);
        }

        this.drawBranch = function() {
          if(!this.drawn) {
            drawBranch(this.from, this.to);
          }
          this.drawn = true;
        }

        this.newBranch = function() {
          if(this.branched || this.iter === MAX_ITERS) {
            return undefined;
          }

          // takes the vector of the current branch and uses it to get the directions of the next two branches
          var dir = {
            x: this.to.x-this.from.x, 
            y: this.to.y-this.from.y
          };
          dir = scale(dir, SCALE_FACTOR);
          var l_bp = branchOff(true, this.to, dir);
          var r_bp = branchOff(false, this.to, dir);
          this.branched = true;

          var lBranch = new branch(this.to, l_bp, this.iter+1);
          var rBranch = new branch(this.to, r_bp, this.iter+1);
          return [lBranch, rBranch];
        }
      }

      function tick() {
        for(var i=branches.length-1; i>=0; i--){
          branches[i].drawBranch();
          var b = branches[i].newBranch();
          if(b !== undefined) {
            for(var j=0; j<b.length; j++) {
              branches.push(b[j]);
            }
          }
        }
      }

      function init() {
        var count=0;
        stage.scaleY=-1;
        stage.y=STAGE_HEIGHT;

        var x=STAGE_WIDTH/2, y=0;

        var posTo = {x, y:y+branchLength};
        var b = new branch({x, y}, posTo);
        branches.push(b);
      }

      // takes x, y points and a direction vector {x, y}
      function drawBranch(from, to) {
        var shape = new createjs.Shape();
        shape.graphics.setStrokeStyle(1).beginStroke("rgba(0,0,0,1)");
        shape.graphics.moveTo(from.x, from.y);
        shape.graphics.lineTo(to.x, to.y);
        shape.graphics.endStroke();
        stage.addChild(shape);
        stage.update();
      }

      // takes a position and returns the position
      // for the end of the new branch to go
      // left: bool (if false, go right)
      function branchOff(left, from, dir) {
        var angle = ANG_R;
        if(left) {
          angle = ANG_L;
        }
        angle += random(ANG_OFFSET);
        var newDir = rotate(dir, angle);
        var scaleFactor = 1-random(SCALE_FACTOR_OFFSET);
        newDir = scale(
          newDir,
          scaleFactor
        );

        var newTo = {
          x: from.x + newDir.x, 
          y: from.y + newDir.y
        };
        return newTo;
      }

      // vec = {x, y}. Angle (radians)
      function rotate(vec, ang) {
        return {
          x: vec.x*Math.cos(ang)-vec.y*Math.sin(ang),
          y: vec.x*Math.sin(ang)+vec.y*Math.cos(ang)
        }
      }
      function scale(vec, scale) {
        return {x: vec.x*scale, y: vec.y*scale};
      }
      function unitVector(vec) {
        var mag = getMag(vec);
        return {x: x/mag, y: y/mag};
      }
      function getMag(vec) {
        return Math.sqrt(vec.x^2+vec.y^2)
      }
      // random number [-max, max];
      function random(max) {
        return (Math.random()*2-1)*max;
      }

      createjs.Ticker.addEventListener("tick", tick);
    </script>
  </body>
</html>